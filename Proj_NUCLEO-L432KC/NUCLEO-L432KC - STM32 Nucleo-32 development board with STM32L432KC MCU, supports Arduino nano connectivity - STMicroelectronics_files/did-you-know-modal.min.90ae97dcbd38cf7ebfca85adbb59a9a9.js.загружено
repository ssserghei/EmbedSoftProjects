var DidYouKnow=function(){var b=this;this.isInitializing=!1;this.dontShowAnymoreExpiresIn=30;this.showModal=function(){b.isInitializing||(b.isInitializing=!0,("undefined"===typeof window.STFED.ipGeolocatedCountryCode||0===window.STFED.ipGeolocatedCountryCode.length?$.ajax({url:"/bin/st/geolocation/ip/country?code\x3dtrue",type:"POST",success:function(a){if(null===a||""===a)throw Error("Bad country code response");return a}}).fail(function(a){console.error("country code retrieval:",a)}):$.when(window.STFED.ipGeolocatedCountryCode)).then(function(a){window.STFED.ipGeolocatedCountryCode=
a;return!0}).then(function(){b.modal=$(".did-you-know");b.modal.length&&b.popupCanBeShown()?b.waitUntilScreenIsDesktop().then(function(){b.isInitializing=!1;b.isInitialized||(b.subscriptionSuccessful=!1,b.assignElements(),b.initListeners(),b.isInitialized=!0);b.goToSubStep(0,0);b.modal.fadeIn()}):b.isInitializing=!1}))};this.waitUntilScreenIsDesktop=function(){var a=$.Deferred(),b=function(){a.resolve();enquire.unregister(STFED.mediaQueries.largeMin,b)};enquire.register(STFED.mediaQueries.largeMin,
b);return a.promise()};this.hideModal=function(){this.modal.fadeOut()};this.assignElements=function(){this.modalBlock=$(".did-you-know--inner");this.modalHeader=$(".did-you-know--header");this.closeModal=$(".btn-close-panel");this.serverError=this.modal.find(".server-error small");this.dontShowCheckbox=$("#dont-show-did-you-know");this.steps=$(".did-you-know--content");this.didYouKnowTermsForm=$("#did-you-know-step1");this.receiveUpdatesBtn=$("#receive-updates");this.termsCheckbox=$("#accept-terms");
this.submitSubscriptionForm=$("#did-you-know-step2");this.didYouKnowEmail=$("#did-you-know-email");this.didYouKnowEmailHidden=$("#did-you-know-email-hidden");this.goBackToEmailEdit=$("#go-back-to-email-edit");this.validateCodeForm=$("#did-you-know-validate-code");this.submitDidntGetCodeBtn=$(".did-you-know--didnt-receive-code");this.codeInputs=this.validateCodeForm.find('input[type\x3d"number"]');this.codeInputsGroup=this.validateCodeForm.find(".code-group");this.didntGetCodeForm=$("#did-you-know--didnt-receive-code-form");
this.didYouKnowEmailRepeat=$("#did-you-know-email-repeat");this.didYouKnowEmailNoEdit=$("#did-you-know-email-no-edit");this.didYouKnowEmailNoEditNoCode=$("#did-you-know-email-no-edit-without-code")};this.popupCanBeShown=function(){return!this.getCookie("dontShowAnymore")};this.initListeners=function(){var a=new RegExp(/\d+/);this.modal.find("form").on("submit",function(b){b.preventDefault()});this.didYouKnowTermsForm.on("valid",function(){b.receiveUpdatesBtn.removeClass("disabled").removeAttr("disabled");
b.goToSubStep(1,1)}).on("invalid",function(){b.receiveUpdatesBtn.addClass("disabled").attr("disabled","disabled")});b.termsCheckbox.on("change",function(){$(this).prop("checked")&&b.receiveUpdatesBtn.removeClass("disabled").removeAttr("disabled")});this.submitSubscriptionForm.on("valid",function(){STFED.preloader.show(b.modalBlock);b.toggleSubmitButton(b.submitSubscriptionForm,!0);b.submit(b.submitSubscriptionForm).then(function(a){if(a&&a instanceof Error)return a;b.syncEmails()}).always(function(a){if(a&&
a instanceof Error)return a;b.syncEmails();b.goToSubStep(1,2)})}).on("invalid",function(){b.toggleSubmitButton(b.submitSubscriptionForm)});this.didYouKnowEmail.on("valid.zf.abide",function(){$(this).closest(".has-backend-error").toggleClass("has-backend-error",!1);b.toggleSubmitButton(b.submitSubscriptionForm,!0)}).on("invalid.zf.abide",function(){$(this).closest(".has-backend-error").toggleClass("has-backend-error",!1);b.toggleSubmitButton(b.submitSubscriptionForm)});this.goBackToEmailEdit.on("click",
function(a){a.preventDefault();b.clearCode();b.resetEnteredCodeValidation();b.toggleBackendError();b.goToSubStep(1,1)});this.codeInputs.on("keydown",function(c){var d=$(this),e=c.keyCode;8!=e&&9!=e&&16!=e&&17!=e&&setTimeout(function(){(48<=e&&57>=e||96<=e&&105>=e)&&d.val(String.fromCharCode(96<=e?e-48:e));var c=d.val();a.test(c)?(c=d.index(),3>c?b.codeInputs.eq(++c).focus():b.codeInputs.blur(),b.enabledCodeSubmit(d)):d.val("")})});this.codeInputs.on("paste",function(){var c=$(this);setTimeout(function(){var d=
c.val()?String(c.val()):"";a.test(d)?(3<d.length?b.codeInputs.each(function(a,b){$(b).val(d.charAt(a))}):c.val(d.charAt(0)),b.enabledCodeSubmit(c)):c.val("")})});this.validateCodeForm.on("submit",function(a){b.toggleBackendError();b.resetEnteredCodeValidation();b.validateEnteredCode()?b.submit(b.validateCodeForm).then(function(a){if(a&&a instanceof Error)return a;b.submitCustomActivity(a);b.subscriptionSuccessful=!0;b.setDontShowAnymoreCookie();$("#reuse-message").show()},function(){b.clearCode()}).always(function(a){if(a&&
a instanceof Error)return a;b.goToSubStep(3,3);$("#reuse-message").show()}):b.toggleSubmitButton(b.validateCodeForm)});this.submitDidntGetCodeBtn.on("click",function(a){a.preventDefault();b.goToSubStep(2,4)});this.didntGetCodeForm.on("valid",function(){b.toggleSubmitButton(b.didntGetCodeForm,!0);b.submit(b.didntGetCodeForm).then(function(a){if(a&&a instanceof Error)return a;b.submitCustomActivity(a);b.setDontShowAnymoreCookie();b.subscriptionSuccessful=!0;$("#reuse-message").hide()}).fail(function(a){if(a&&
a instanceof Error)return a}).always(function(a){a&&a instanceof Error||(b.setDontShowAnymoreCookie(),b.goToSubStep(3,5),$("#reuse-message").hide())})}).on("invalid",function(){b.toggleSubmitButton(b.didntGetCodeForm)});this.closeModal.on("click",function(a){a.preventDefault();b.hideModal();b.onModalClose()});b.dontShowCheckbox.on("change",function(){b.receiveUpdatesBtn.prop("disabled",this.checked)})};this.submitCustomActivity=function(a){if("undefined"!==typeof a&&null!==a){a=JSON.parse(a.preferencesIDs);
for(var b in a){var d={productID:b,category:a[b].category,categoryDescription:a[b].itemName,sPreferenceSource:"didYouKnowPopUp",additionDate:(new Date).toJSON()};CustomActivities.submitCustomActivity(CustomActivities.types.PRODUCT_PREFERENCE_TYPE,d,a[b].itemName)}}};this.submit=function(a){var c=a.attr("action"),d=a.serialize(),e={customObjectData:CustomActivities.getCustomActivityData()};this.toggleSubmitButton(a);return $.ajax({type:"POST",url:c,data:d+"\x26"+$.param(e),dataType:"json"}).then(function(a){if(a){if(void 0!==
a.ok&&void 0!==a.validationCode)b.submitMktoForm("marketo-did-you-know-form",a.validationCode);else{if(void 0!==a.errorKS)return b.toggleServerError(),b.toggleBackendError(!0,window.didYouKnowModalMessages.generalServerError),Error(window.didYouKnowModalMessages.generalServerError);if(void 0!==a.invalidCode)return b.toggleServerError(),b.toggleBackendError(!0,window.didYouKnowModalMessages.invalidCodeError),Error(window.didYouKnowModalMessages.invalidCodeError)}return a}b.toggleBackendError();b.toggleServerError()}).fail(function(a){b.toggleServerError(!0,
a)}).always(function(){b.toggleSubmitButton(a,!0)})};this.submitMktoForm=function(a,c){a=b.findMarketoFormById(a);"undefined"!==typeof a&&null!==a&&(a.onSuccess(function(){return!1}),a.addHiddenFields({Email:c.userEmail,otpCode:c.code}),a.submit())};this.findMarketoFormById=function(a){a=$("#"+a);if("undefined"===typeof a||null===a||0===a.length)return null;a=a.find("form");if("undefined"===typeof a||null===a||0===a.length)return null;a=a.attr("id");var b=a.lastIndexOf("_");a=MktoForms2.getForm(a.substring(b+
1));return"undefined"!==typeof a&&null!==a?a:null};this.clearCode=function(){var a=this;this.codeInputs.each(function(){$(this).val("");a.validateEnteredCode()})};this.toggleBackendError=function(a,b){this.currentFormContainer.toggleClass("has-backend-error",a);a?(this.currentFormContainer.find(".backend-error").html(b),this.currentFormContainer.find(".backend-error").show()):(this.steps.find(".backend-error").html(""),this.steps.find(".backend-error").hide())};this.toggleServerError=function(a,b){a?
(a=b&&b.message?b.message:"",this.serverError.addClass("shown").html(a)):this.serverError.removeClass("shown").html("")};this.syncEmails=function(){var a=this.didYouKnowEmail.val();this.didYouKnowEmailHidden.val(a);this.didYouKnowEmailRepeat.val(a);this.didYouKnowEmailNoEdit.text(a);this.didYouKnowEmailNoEditNoCode.text(a)};this.toggleSubmitButton=function(a,b){a=$('[type\x3d"submit"]',a);b?a.removeClass("disabled").removeAttr("disabled"):a.addClass("disabled").attr("disabled","disabled")};this.goToStep=
function(a){return this.currentFormContainer=this.steps.removeClass("shown").filter(function(){return $(this).hasClass("step-"+a)}).addClass("shown")};this.goToSubStep=function(a,c){STFED.preloader&&STFED.preloader.hide(b.modalBlock);this.steps.add(this.modalHeader).find('[class^\x3d"substep-"]').removeClass("shown");this.currentFormContainer=this.goToStep(a).add(this.modalHeader).find(".substep-"+c).addClass("shown")};this.enabledCodeSubmit=function(a){a.removeClass("error").closest(".code-group").removeClass("invalid");
b.toggleSubmitButton(b.validateCodeForm,!0)};this.validateEnteredCode=function(){var a="",c=!1;b.codeInputs.each(function(){$(this).val()?a+=$(this).val():(c=!0,b.codeInputsGroup.addClass("invalid"),$(this).addClass("error"))});return!c};this.resetEnteredCodeValidation=function(){b.codeInputsGroup.toggleClass("invalid",!1);b.codeInputs.each(function(){$(this).toggleClass("error",!1)})};this.setCookie=function(a,b,d){d.expires&&d.expires.toUTCString&&(d.expires=d.expires.toUTCString());a=encodeURIComponent(a)+
"\x3d"+encodeURIComponent(b);for(var c in d)a+="; "+c,b=d[c],!0!==b&&(a+="\x3d"+b);document.cookie=a};this.getCookie=function(a){return(a=document.cookie.match("(^|;) ?"+a+"\x3d([^;]*)(;|$)"))?a[2]:null};this.setDontShowAnymoreCookie=function(){var a={path:"/"};b.dontShowCheckbox.prop("checked")&&(a.expires=new Date(Date.now()+31536E7));b.setCookie("dontShowAnymore","1",a)};this.onModalClose=function(){b.setDontShowAnymoreCookie()}};window.STFED=window.STFED||{};window.STFED.didYouKnowModal=new DidYouKnow;
$(document).on("click",".js-show-did-you-know-modal",function(b){window.STFED.didYouKnowModal.showModal()});